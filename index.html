<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pi√±ata - Janeth Vazquez</title>
    <style>
        :root {
            --bg1: #0b1220;
            --bg2: #101b35;
            --border: rgba(255, 255, 255, .14);
            --text: #eaf2ff;
            --muted: rgba(234, 242, 255, .78);
            --accent: #f7c948;
            --pink: #fb7185;
            --blue: #60a5fa;
            --violet: #a78bfa;
            --ok: #22c55e;
            --danger: #ef4444;
            --shadow: 0 18px 55px rgba(0, 0, 0, .45);
            --radius: 22px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            color: var(--text);
            background:
                radial-gradient(1200px 700px at 18% -10%, rgba(247, 201, 72, .20), transparent 60%),
                radial-gradient(1000px 700px at 90% 0%, rgba(167, 139, 250, .25), transparent 55%),
                radial-gradient(900px 600px at 55% 110%, rgba(96, 165, 250, .22), transparent 55%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
            min-height: 100vh;
            overflow-x: hidden;
        }

        .wrap {
            max-width: 1020px;
            margin: 0 auto;
            padding: 18px 14px 44px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .person {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 260px;
        }

        .avatar {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .18);
            background: linear-gradient(135deg, rgba(251, 113, 133, .55), rgba(247, 201, 72, .35));
            overflow: hidden;
            box-shadow: 0 14px 30px rgba(0, 0, 0, .35);
            flex: 0 0 auto;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .person .name {
            line-height: 1.1;
        }

        .person .name b {
            display: block;
            letter-spacing: .02em;
            font-size: 1.05rem;
        }

        .person .name a {
            color: rgba(234, 242, 255, .85);
            text-decoration: underline;
            text-underline-offset: 3px;
            font-size: .9rem;
        }

        .right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
            align-items: center;
        }

        .pill {
            padding: 9px 12px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, .06);
            font-size: .92rem;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .pill b {
            color: var(--text);
        }

        .pill .ok {
            color: var(--ok);
            font-weight: 900;
        }

        .pill .bad {
            color: var(--danger);
            font-weight: 900;
        }

        .panel {
            border: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .06));
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
        }

        .stage {
            position: relative;
            height: min(640px, 78vh);
            min-height: 520px;
            padding: 14px;
            overflow: hidden;
        }

        @media (max-width: 560px) {
            .stage {
                height: 80vh;
                min-height: 560px;
                padding: 10px;
            }
        }

        .panel-top {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            pointer-events: none;
            z-index: 5;
        }

        .panel-top .minirow {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            pointer-events: none;
        }

        .mini-pill {
            pointer-events: none;
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(0, 0, 0, .18);
            color: rgba(234, 242, 255, .82);
            font-size: .86rem;
            backdrop-filter: blur(8px);
            white-space: nowrap;
        }

        .lights {
            position: absolute;
            inset: -60px;
            pointer-events: none;
            opacity: 0;
            transition: opacity .2s ease;
            mix-blend-mode: screen;
            background:
                radial-gradient(260px 200px at 20% 25%, rgba(247, 201, 72, .60), transparent 62%),
                radial-gradient(280px 220px at 80% 30%, rgba(167, 139, 250, .60), transparent 64%),
                radial-gradient(300px 240px at 40% 85%, rgba(96, 165, 250, .60), transparent 64%);
            filter: blur(2px);
            z-index: 1;
        }

        .lights.on {
            opacity: 1;
        }

        .lights.pulse {
            animation: lightsPulse 750ms ease-out 1;
        }

        @keyframes lightsPulse {
            0% {
                opacity: .08;
            }

            40% {
                opacity: 1;
            }

            100% {
                opacity: .18;
            }
        }

        #fx {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: block;
            z-index: 2;
        }

        .voices {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 3;
        }

        .voice {
            position: absolute;
            font-weight: 950;
            letter-spacing: .02em;
            text-transform: uppercase;
            font-size: clamp(18px, 3.2vw, 36px);
            color: rgba(255, 255, 255, .94);
            text-shadow: 0 18px 40px rgba(0, 0, 0, .55);
            opacity: 0;
            animation: pop 1.25s ease-out forwards, shake 240ms linear 0s 5;
            user-select: none;
            white-space: nowrap;
            filter: drop-shadow(0 18px 30px rgba(0, 0, 0, .45));
        }

        @keyframes pop {
            0% {
                opacity: 0;
                transform: translateY(14px) scale(.96);
            }

            14% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            86% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                transform: translateY(-10px) scale(1.02);
            }
        }

        @keyframes shake {
            0% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(2px, -2px) scale(1.02);
            }

            50% {
                transform: translate(-2px, 2px) scale(1.02);
            }

            75% {
                transform: translate(2px, 2px) scale(1.02);
            }

            100% {
                transform: translate(0, 0) scale(1);
            }
        }

        .play-area {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            z-index: 2;
        }

        .rope {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 150px;
            background: rgba(255, 255, 255, .18);
            border-radius: 999px;
            filter: drop-shadow(0 10px 10px rgba(0, 0, 0, .35));
            z-index: 2;
        }

        .pinata-wrap {
            position: absolute;
            top: 138px;
            left: 50%;
            width: 340px;
            height: 360px;
            transform: translateX(-50%);
            transform-origin: top center;
            animation: swing 3.2s ease-in-out infinite;
            z-index: 2;
            pointer-events: auto;
            cursor: pointer;
            user-select: none;
        }

        @keyframes swing {
            0% {
                transform: translateX(-50%) rotate(-5deg);
            }

            50% {
                transform: translateX(-50%) rotate(6deg);
            }

            100% {
                transform: translateX(-50%) rotate(-5deg);
            }
        }

        @media (max-width: 560px) {
            .pinata-wrap {
                top: 140px;
                width: 290px;
                height: 330px;
            }

            .rope {
                height: 160px;
            }
        }

        .bat {
            position: absolute;
            right: 18px;
            bottom: 86px;
            width: 250px;
            height: 16px;
            transform-origin: 20px 50%;
            transform: rotate(-18deg);
            opacity: .92;
            filter: drop-shadow(0 14px 22px rgba(0, 0, 0, .45));
            z-index: 2;
            pointer-events: none;
        }

        .bat .wood {
            position: absolute;
            left: 22px;
            top: 1px;
            width: 220px;
            height: 14px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .16), rgba(0, 0, 0, 0)),
                linear-gradient(90deg, #b7791f, #d9a441, #b7791f);
            border: 1px solid rgba(255, 255, 255, .12);
        }

        .bat .handle {
            position: absolute;
            left: 0;
            top: -1px;
            width: 30px;
            height: 18px;
            border-radius: 10px;
            background: linear-gradient(90deg, #3f2f1d, #6b4f2a);
            border: 1px solid rgba(255, 255, 255, .12);
        }

        /* golpe m√°s lento + temblor fuerte */
        .bat.swing {
            animation: batSwing 980ms cubic-bezier(.15, .95, .2, 1) 1, batShake 220ms linear 0s 6;
        }

        @keyframes batSwing {
            0% {
                transform: rotate(-18deg) translate(0, 0);
            }

            35% {
                transform: rotate(-68deg) translate(-12px, -7px);
            }

            62% {
                transform: rotate(-10deg) translate(0, 0);
            }

            100% {
                transform: rotate(-18deg) translate(0, 0);
            }
        }

        @keyframes batShake {
            0% {
                transform: rotate(-18deg) translate(0, 0);
            }

            25% {
                transform: rotate(-17deg) translate(1px, -1px);
            }

            50% {
                transform: rotate(-19deg) translate(-1px, 1px);
            }

            75% {
                transform: rotate(-17deg) translate(1px, 1px);
            }

            100% {
                transform: rotate(-18deg) translate(0, 0);
            }
        }

        .helpbar {
            position: absolute;
            left: 10px;
            right: 10px;
            bottom: 10px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            z-index: 4;
        }

        .btn {
            border: none;
            cursor: pointer;
            border-radius: 999px;
            padding: 10px 14px;
            font-weight: 900;
            letter-spacing: .01em;
            color: #0b1220;
            background: linear-gradient(135deg, var(--accent), var(--pink));
            box-shadow: 0 16px 32px rgba(247, 201, 72, .18);
            user-select: none;
        }

        .btn:disabled {
            opacity: .55;
            cursor: not-allowed;
            filter: grayscale(.1);
        }

        .btn-ghost {
            background: rgba(255, 255, 255, .08);
            color: var(--text);
            border: 1px solid var(--border);
            box-shadow: none;
        }

        .hint {
            padding: 9px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .14);
            background: rgba(0, 0, 0, .18);
            color: rgba(234, 242, 255, .82);
            font-size: .9rem;
            backdrop-filter: blur(8px);
            white-space: nowrap;
        }

        .candies {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 2;
        }

        .candy {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 4px;
            opacity: .95;
            transform: translateY(-20px) rotate(0deg);
            animation: fall 2.6s ease-in forwards;
            box-shadow: 0 10px 20px rgba(0, 0, 0, .35);
        }

        @keyframes fall {
            0% {
                transform: translateY(-30px) rotate(0deg);
                opacity: 0;
            }

            12% {
                opacity: 1;
            }

            100% {
                transform: translateY(1000px) rotate(420deg);
                opacity: 1;
            }
        }

        /* Candado / invitaci√≥n central */
        .gate {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            background: rgba(2, 6, 23, .60);
            backdrop-filter: blur(12px);
            z-index: 20;
            padding: 16px;
        }

        .gate.hide {
            display: none;
        }

        .gate-card {
            width: min(680px, 100%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, .16);
            background: linear-gradient(180deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
            box-shadow: 0 30px 80px rgba(0, 0, 0, .55);
            padding: 18px;
            text-align: center;
        }

        .gate-card h1 {
            margin: 0 0 10px;
            font-size: clamp(24px, 4vw, 44px);
            letter-spacing: .01em;
        }

        .gate-card p {
            margin: 0 0 14px;
            color: rgba(234, 242, 255, .82);
            line-height: 1.5;
        }

        .gate-btn {
            border: none;
            cursor: pointer;
            border-radius: 999px;
            padding: 12px 16px;
            font-weight: 950;
            letter-spacing: .01em;
            color: #0b1220;
            background: linear-gradient(135deg, var(--accent), var(--pink));
            box-shadow: 0 18px 40px rgba(247, 201, 72, .22);
        }

        /* N√∫mero grande 5..1 */
        .countflash {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            pointer-events: none;
            z-index: 6;
            opacity: 0;
        }

        .countflash.show {
            opacity: 1;
            animation: flash 900ms ease-out 1;
        }

        .countflash .num {
            font-size: clamp(64px, 14vw, 140px);
            font-weight: 1000;
            letter-spacing: .02em;
            background: linear-gradient(135deg, var(--accent), var(--pink), var(--violet));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 22px 60px rgba(0, 0, 0, .55);
            filter: drop-shadow(0 22px 40px rgba(0, 0, 0, .4));
        }

        @keyframes flash {
            0% {
                transform: scale(.88);
                opacity: 0;
            }

            18% {
                transform: scale(1);
                opacity: 1;
            }

            70% {
                transform: scale(1.02);
                opacity: 1;
            }

            100% {
                transform: scale(1.06);
                opacity: 0;
            }
        }

        /* Overlay final */
        .overlay {
            position: absolute;
            inset: 0;
            display: none;
            place-items: center;
            padding: 14px;
            background: rgba(2, 6, 23, .42);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .overlay.show {
            display: grid;
        }

        .modal {
            max-width: 920px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, .16);
            border-radius: 22px;
            background: linear-gradient(180deg, rgba(255, 255, 255, .12), rgba(255, 255, 255, .06));
            box-shadow: 0 22px 70px rgba(0, 0, 0, .55);
            padding: 16px;

            /* ‚úÖ clave: que el contenido se distribuya y no se trague botones */
            display: flex;
            flex-direction: column;
            max-height: min(86vh, 760px);
            overflow: hidden;
        }

        .modal h2 {
            margin: 0 0 10px;
            font-size: clamp(24px, 4vw, 40px);
            text-align: center;
            flex: 0 0 auto;
        }

        .modal h2 {
            margin: 0 0 10px;
            font-size: clamp(24px, 4vw, 40px);
            text-align: center;
        }

        .msgbox {
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .06);
            border-radius: 16px;
            padding: 14px;
            color: rgba(234, 242, 255, .90);
            line-height: 1.55;
            white-space: pre-wrap;
            overflow: auto;
            max-height: min(46vh, 360px);
        }

        @media (max-width: 560px) {
            .msgbox {
                max-height: 44vh;
                padding: 12px;
            }
        }

        .actions {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        a.link {
            color: rgba(234, 242, 255, .92);
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        /* FB section */
        .fbwrap {
            margin-top: 14px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(0, 0, 0, .18);
            padding: 12px;
        }

        .fbwrap h3 {
            margin: 0 0 8px;
            font-size: 1rem;
            color: rgba(234, 242, 255, .88);
            text-align: center;
        }

        .fbnote {
            margin: 0 0 10px;
            text-align: center;
            color: rgba(234, 242, 255, .72);
            font-size: .9rem;
            line-height: 1.45;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header>
            <div class="person">
                <div class="avatar" title="Janeth Vazquez">
                    <img id="profileImg" alt="Janeth Vazquez" />
                </div>
                <div class="name">
                    <b id="personName">Janeth Vazquez</b>
                    <a id="personLink" target="_blank" rel="noopener">Facebook</a>
                </div>
            </div>

            <div class="right">
                <div class="pill" id="hitsPill">Golpes: <b id="hits">1</b>/5</div>
                <div class="pill" id="statePill">Estado: <b>Esperando</b></div>
            </div>
        </header>

        <section class="panel">
            <div class="stage" id="stage">

                <div class="panel-top">
                    <div class="minirow">
                        <div class="mini-pill" id="audChant">üéµ Audio dale: <b>‚Äî</b></div>
                        <div class="mini-pill" id="audMan">üé∂ Ma√±anitas: <b>‚Äî</b></div>
                    </div>
                    <div class="minirow">
                        <div class="mini-pill">Tip: clic en la pi√±ata ü™Ö</div>
                    </div>
                </div>

                <div class="lights" id="lights"></div>
                <canvas id="fx"></canvas>
                <div class="voices" id="voices"></div>
                <div class="candies" id="candies"></div>

                <div class="countflash" id="countFlash">
                    <div class="num" id="countNum">5</div>
                </div>

                <div class="play-area">
                    <div class="rope"></div>

                    <div class="pinata-wrap" id="pinataWrap" title="Clic para golpear">
                        <svg viewBox="0 0 340 340" width="100%" height="100%" aria-hidden="true">
                            <defs>
                                <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                                    <stop offset="0" stop-color="#f7c948" stop-opacity="0.95" />
                                    <stop offset="1" stop-color="#fb7185" stop-opacity="0.85" />
                                </linearGradient>
                                <linearGradient id="g2" x1="0" x2="1" y1="0" y2="1">
                                    <stop offset="0" stop-color="#60a5fa" stop-opacity="0.55" />
                                    <stop offset="1" stop-color="#a78bfa" stop-opacity="0.55" />
                                </linearGradient>
                                <filter id="shadow" x="-30%" y="-30%" width="160%" height="160%">
                                    <feDropShadow dx="0" dy="18" stdDeviation="18" flood-color="#000"
                                        flood-opacity="0.45" />
                                </filter>
                            </defs>
                            <g filter="url(#shadow)" id="starGroup">
                                <path
                                    d="M170 26 L198 108 L284 108 L214 158 L242 240 L170 194 L98 240 L126 158 L56 108 L142 108 Z"
                                    fill="url(#g1)" stroke="rgba(255,255,255,.18)" stroke-width="2" />
                                <path
                                    d="M170 52 L190 110 L252 110 L205 142 L222 202 L170 170 L118 202 L135 142 L88 110 L150 110 Z"
                                    fill="rgba(255,255,255,.08)" />
                                <path
                                    d="M170 78 L184 116 L220 116 L191 134 L202 168 L170 150 L138 168 L149 134 L120 116 L156 116 Z"
                                    fill="rgba(255,255,255,.10)" />
                                <circle cx="170" cy="140" r="26" fill="url(#g2)" opacity="0.95" />
                                <circle cx="160" cy="130" r="10" fill="rgba(255,255,255,.25)" />
                                <g opacity="0.75">
                                    <path
                                        d="M92 224 C120 244, 138 252, 170 268 C202 252, 220 244, 248 224 L248 256 C220 280, 190 294, 170 306 C150 294, 120 280, 92 256 Z"
                                        fill="url(#g2)" />
                                </g>
                                <g id="crack" opacity="0">
                                    <path d="M170 54 L158 96 L178 128 L166 156 L184 192 L164 230"
                                        stroke="rgba(255,255,255,.78)" stroke-width="4" stroke-linecap="round" />
                                    <path d="M156 78 L170 110 L150 138 L168 178 L152 210" stroke="rgba(255,255,255,.62)"
                                        stroke-width="3" stroke-linecap="round" />
                                </g>
                            </g>
                        </svg>
                    </div>

                    <div class="bat" id="bat" aria-hidden="true">
                        <div class="handle"></div>
                        <div class="wood"></div>
                    </div>
                </div>

                <div class="helpbar">
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button type="button" class="btn" id="btnHelpHit" disabled>ü™µ Dar golpe (ayuda)</button>
                        <button type="button" class="btn btn-ghost" id="btnReset" disabled>Reset</button>
                    </div>
                    <div class="hint">Al 5to golpe‚Ä¶ üí• revienta + ma√±anitas</div>
                </div>

                <!-- CANDADO / INVITACI√ìN -->
                <div class="gate" id="gate">
                    <div class="gate-card">
                        <h1>üîí Fuiste invitado üòè</h1>
                        <p>
                            Dale click para comprobar‚Ä¶<br />
                            (y desbloquear la m√∫sica üéµ + la pi√±ata ü™Ö)
                        </p>
                        <button class="gate-btn" type="button" id="btnEnter">‚úÖ Click para comprobar</button>
                    </div>
                </div>

                <!-- FINAL -->
                <div class="overlay" id="overlay">
                    <div class="modal">
                        <h2>üéâ ¬°Felicidades! üéÇ‚ú®</h2>
                        <div class="msgbox" id="finalMsg"></div>

                        <!-- FB comments -->
                        <div class="fbwrap">
                            <h3>üí¨ Felicitaciones de Facebook (comentarios)</h3>
                            <p class="fbnote">
                                Esto funciona cuando tu p√°gina est√© publicada (HTTPS).<br>
                                La liga de ‚Äúbirthdays‚Äù de Facebook no se puede mostrar embebida por seguridad,
                                pero aqu√≠ s√≠ puedes tener felicitaciones reales en tu p√°gina.
                            </p>

                            <!-- SDK Facebook root -->
                            <div id="fb-root"></div>
                            <div class="fb-comments" data-href="" data-width="100%" data-numposts="6"></div>
                        </div>

                        <div class="actions">
                            <button type="button" class="btn" id="btnReplay">Repetir üéÅ</button>
                            <button type="button" class="btn btn-ghost" id="btnAudioToggle">Pausar m√∫sica üîá</button>
                            <a class="btn btn-ghost link" id="fbLink" target="_blank" rel="noopener">Facebook üíô</a>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <script>
        // =========================
        // CONFIG
        // =========================
        const CHANT_URL = "./dale-dale.mp3";
        const MANANITAS_URL = "./mananitas.mp3";
        const MAX_HITS = 5;

        const PERSON_NAME = "Janeth Vazquez";
        const FACEBOOK_URL = "https://www.facebook.com/janeth.roldan.838315";
        const PROFILE_IMG_URL = "./Janeth.jpg"; // ya la pusiste en la misma ruta ‚úÖ

        const VOICE_MESSAGES = [
            "¬°DALE!", "¬°Dale, dale!", "¬°No pierdas el tino!",
            "¬°Si lo pierdes, pierdes el camino!", "¬°Con ganas!", "¬°M√°s fuerte!", "¬°WOOOOO!"
        ];

       const FINAL_TEXT = `Feliz cumple üéÇ

Otro a√±o m√°s sobreviviendo al mundo, y la neta qu√© bueno que me toc√≥ coincidir contigo.
Gracias por las pl√°ticas, las risas, el apoyo y hasta por aguantarme cuando ando medio wey.

Ojal√° este a√±o te traiga cosas chidas, tranquilidad, dinero jajaja y varios d√≠as que valgan la pena recordar.

No cambies tu forma de ser, porque justo as√≠ caes bien.
P√°sala muy bonito hoy.

Te quiero, amiga ‚ú®`;


        // =========================
        // HELPERS seguros
        // =========================
        const $ = (id) => document.getElementById(id);
        const isArray = (a) => Array.isArray(a);

        function safeNumber(n, def = 0) {
            const x = Number(n);
            return Number.isFinite(x) ? x : def;
        }
        function clamp(n, min, max) {
            const x = safeNumber(n, 0);
            return Math.max(min, Math.min(max, x));
        }
        function randInt(min, max) {
            const a = safeNumber(min, 0);
            const b = safeNumber(max, 0);
            const lo = Math.min(a, b);
            const hi = Math.max(a, b);
            return Math.floor(Math.random() * (hi - lo + 1)) + lo;
        }
        function setHTMLSafe(el, html) { if (el) el.innerHTML = String(html ?? ""); }
        function setTextSafe(el, txt) { if (el) el.textContent = String(txt ?? ""); }

        // =========================
        // ELEMENTOS
        // =========================
        const stage = $("stage");
        const voices = $("voices");
        const candies = $("candies");
        const lights = $("lights");

        const hitsEl = $("hits");
        const hitsPill = $("hitsPill");
        const statePill = $("statePill");

        const pinataWrap = $("pinataWrap");
        const crack = $("crack");
        const bat = $("bat");

        const overlay = $("overlay");
        const finalMsg = $("finalMsg");
        const fbLink = $("fbLink");

        const btnHelpHit = $("btnHelpHit");
        const btnReset = $("btnReset");
        const btnReplay = $("btnReplay");
        const btnAudioToggle = $("btnAudioToggle");

        const audChant = $("audChant");
        const audMan = $("audMan");

        const gate = $("gate");
        const btnEnter = $("btnEnter");

        const countFlash = $("countFlash");
        const countNum = $("countNum");

        const personName = $("personName");
        const personLink = $("personLink");
        const profileImg = $("profileImg");

        const fxCanvas = $("fx");
        const ctx = fxCanvas && typeof fxCanvas.getContext === "function" ? fxCanvas.getContext("2d") : null;

        // =========================
        // HEADER
        // =========================
        setTextSafe(personName, PERSON_NAME);
        if (personLink) { personLink.href = FACEBOOK_URL; setTextSafe(personLink, "Facebook"); }
        if (fbLink) fbLink.href = FACEBOOK_URL;
        if (profileImg) profileImg.src = PROFILE_IMG_URL;
        if (finalMsg) setTextSafe(finalMsg, FINAL_TEXT);

        // =========================
        // AUDIO
        // =========================
        const chantAudio = new Audio(CHANT_URL);
        chantAudio.preload = "auto";
        chantAudio.loop = true;

        const mananitasAudio = new Audio(MANANITAS_URL);
        mananitasAudio.preload = "auto";
        mananitasAudio.loop = false;

        function setAudioPill(el, ok, label) {
            const state = ok ? '<span class="ok">OK</span>' : '<span class="bad">FAIL</span>';
            setHTMLSafe(el, `${label}: <b>${state}</b>`);
        }
        function playSafe(aud) {
            if (!aud || typeof aud.play !== "function") return Promise.resolve(false);
            try {
                const p = aud.play();
                if (p && typeof p.then === "function") return p.then(() => true).catch(() => false);
                return Promise.resolve(true);
            } catch (e) { return Promise.resolve(false); }
        }
        function pauseSafe(aud) { try { aud.pause(); } catch (e) { } }
        function stopSafe(aud) { pauseSafe(aud); try { aud.currentTime = 0; } catch (e) { } }

        chantAudio.addEventListener("canplaythrough", () => setAudioPill(audChant, true, "üéµ Audio dale"));
        chantAudio.addEventListener("error", () => setAudioPill(audChant, false, "üéµ Audio dale"));
        mananitasAudio.addEventListener("canplaythrough", () => setAudioPill(audMan, true, "üé∂ Ma√±anitas"));
        mananitasAudio.addEventListener("error", () => setAudioPill(audMan, false, "üé∂ Ma√±anitas"));

        // =========================
        // VOCES
        // =========================
        let voicesOn = true;
        let voiceTimer = null;

        function spawnVoice(text) {
            if (!voices || !stage) return;
            const msg = String(text || "").trim();
            if (!msg) return;

            const el = document.createElement("div");
            el.className = "voice";
            el.textContent = msg;
            voices.appendChild(el);

            const rect = stage.getBoundingClientRect();
            const w = rect?.width || 900;
            const h = rect?.height || 560;

            const margin = 14;
            const elW = Math.max(80, el.offsetWidth || 200);
            const elH = Math.max(40, el.offsetHeight || 44);

            const maxX = Math.max(margin, Math.floor(w - elW - margin));
            const maxY = Math.max(margin, Math.floor(h - elH - margin - 90));

            el.style.left = randInt(margin, maxX) + "px";
            el.style.top = randInt(70, maxY) + "px";

            setTimeout(() => { if (el?.parentNode) el.parentNode.removeChild(el); }, 1400);
        }

        function startVoices() {
            stopVoices();
            if (!voicesOn) return;
            voiceTimer = setInterval(() => {
                const list = isArray(VOICE_MESSAGES) ? VOICE_MESSAGES : ["¬°DALE!"];
                const pick = list[randInt(0, Math.max(0, list.length - 1))] || "¬°DALE!";
                spawnVoice(pick);
            }, 760);
        }
        function stopVoices() {
            if (voiceTimer) { clearInterval(voiceTimer); voiceTimer = null; }
        }

        // =========================
        // FX CANVAS: confetti + polvo
        // =========================
        let particles = [];
        let raf = 0;
        let running = false;

        function resizeCanvas() {
            if (!fxCanvas || !stage) return;
            const rect = stage.getBoundingClientRect();
            fxCanvas.width = Math.max(1, Math.floor(rect.width));
            fxCanvas.height = Math.max(1, Math.floor(rect.height));
        }
        function pushParticles(newParts) {
            if (!isArray(newParts) || newParts.length === 0) return;
            particles = particles.concat(newParts);
            running = true;
            loopFX();
        }
        function burstConfetti(count = 160, spread = 85) {
            if (!ctx || !fxCanvas) return;
            resizeCanvas();

            const w = fxCanvas.width, h = fxCanvas.height;
            const cx = w / 2, cy = h / 2 - 70;
            const n = clamp(count, 40, 520);
            const out = [];

            for (let i = 0; i < n; i++) {
                const size = randInt(5, 12);
                out.push({
                    type: "confetti",
                    x: cx + randInt(-spread, spread),
                    y: cy + randInt(-spread, spread),
                    vx: (Math.random() - 0.5) * 11,
                    vy: (Math.random() - 0.92) * 13,
                    g: 0.22 + Math.random() * 0.28,
                    r: size,
                    rot: Math.random() * Math.PI,
                    vr: (Math.random() - 0.5) * 0.26,
                    alpha: 1,
                    life: 150 + randInt(0, 90),
                    hue: randInt(0, 360)
                });
            }
            pushParticles(out);
        }
        function burstDust(count = 120, spread = 75) {
            if (!ctx || !fxCanvas) return;
            resizeCanvas();

            const w = fxCanvas.width, h = fxCanvas.height;
            const cx = w / 2, cy = h / 2 - 60;
            const n = clamp(count, 40, 240);
            const out = [];

            for (let i = 0; i < n; i++) {
                const r = 2 + Math.random() * 3.8;
                out.push({
                    type: "dust",
                    x: cx + randInt(-spread, spread),
                    y: cy + randInt(-spread, spread),
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.88) * 10,
                    g: 0.12 + Math.random() * 0.18,
                    r,
                    alpha: 0.75 + Math.random() * 0.22,
                    life: 95 + randInt(0, 60)
                });
            }
            pushParticles(out);
        }
        function loopFX() {
            if (!ctx || !fxCanvas || !running) return;
            const w = fxCanvas.width, h = fxCanvas.height;
            ctx.clearRect(0, 0, w, h);

            particles.forEach(p => {
                p.vy += p.g;
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 1;

                if (p.life < 45) p.alpha = Math.max(0, p.alpha * 0.97);

                ctx.save();
                ctx.globalAlpha = p.alpha;

                if (p.type === "dust") {
                    ctx.fillStyle = "rgba(255,255,255,.9)";
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    p.rot = (p.rot || 0) + (p.vr || 0);
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rot);
                    ctx.fillStyle = `hsla(${p.hue}, 92%, 62%, ${p.alpha})`;
                    ctx.fillRect(-p.r / 2, -p.r / 2, p.r, p.r * 0.8);
                }

                ctx.restore();
            });

            particles = particles.filter(p => p.life > 0 && p.y < h + 90);
            if (particles.length === 0) {
                running = false;
                ctx.clearRect(0, 0, w, h);
                return;
            }
            raf = requestAnimationFrame(loopFX);
        }
        function stopFX() {
            running = false;
            if (raf) cancelAnimationFrame(raf);
            raf = 0;
            particles = [];
            if (ctx) ctx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);
        }

        // =========================
        // DULCES
        // =========================
        function spawnCandies(count = 38) {
            if (!candies || !stage) return;
            candies.innerHTML = "";

            const rect = stage.getBoundingClientRect();
            const w = rect?.width || 900;

            const n = clamp(count, 10, 90);
            for (let i = 0; i < n; i++) {
                const el = document.createElement("div");
                el.className = "candy";
                el.style.left = randInt(Math.floor(w / 2 - 160), Math.floor(w / 2 + 160)) + "px";
                el.style.top = randInt(170, 260) + "px";
                const hue = randInt(0, 360);
                el.style.background = `linear-gradient(135deg, hsla(${hue},95%,60%,.98), hsla(${(hue + 40) % 360},95%,55%,.95))`;
                el.style.animationDelay = (Math.random() * 0.35).toFixed(3) + "s";
                candies.appendChild(el);
                setTimeout(() => { if (el?.parentNode) el.parentNode.removeChild(el); }, 2900);
            }
        }

        // =========================
        // LUCES (m√°s destellos)
        // =========================
        function multiPulse(times = 3) {
            if (!lights) return;
            let t = 0;
            const run = () => {
                lights.classList.remove("pulse");
                void lights.offsetWidth;
                lights.classList.add("pulse");
                t++;
                if (t < times) setTimeout(run, 220);
            };
            run();
        }

        // =========================
        // COUNT FLASH 5..1
        // =========================
        function showCount(n) {
            if (!countFlash || !countNum) return;
            setTextSafe(countNum, String(n));
            countFlash.classList.remove("show");
            void countFlash.offsetWidth;
            countFlash.classList.add("show");
        }

        // =========================
        // GAME
        // =========================
        let hits = 0;
        let broken = false;
        let overlayTimer = 0;

        function setState(html) {
            setHTMLSafe(statePill, `Estado: <b>${html}</b>`);
        }
        function updateHitsUI() {
            if (hitsEl) hitsEl.textContent = String(hits);
            setHTMLSafe(hitsPill, `Golpes: <b id="hits">${hits}</b>/${MAX_HITS}`);
        }
        function showCrack(on) {
            if (!crack) return;
            crack.style.opacity = on ? "1" : "0";
        }
        function batSwing() {
            if (!bat) return;
            bat.classList.remove("swing");
            void bat.offsetWidth;
            bat.classList.add("swing");
            setTimeout(() => bat.classList.remove("swing"), 1100);
        }
        function starNudge() {
            if (!pinataWrap) return;
            pinataWrap.animate(
                [
                    { transform: "translateX(-50%) rotate(0deg)" },
                    { transform: "translateX(-50%) rotate(-10deg)" },
                    { transform: "translateX(-50%) rotate(9deg)" },
                    { transform: "translateX(-50%) rotate(0deg)" }
                ],
                { duration: 900, easing: "cubic-bezier(.12,.95,.2,1)" }
            );
        }

        async function switchToMananitas() {
            stopSafe(chantAudio);
            await playSafe(mananitasAudio);
            setAudioPill(audMan, !mananitasAudio.paused, "üé∂ Ma√±anitas");
        }

        function hitEffects() {
            // por golpe: M√ÅS WOOOOU destellos
            burstConfetti(180, 95);
            burstDust(140, 85);
            multiPulse(4);
        }
        function breakEffects() {
            if (lights) lights.classList.add("on");
            showCrack(true);
            burstConfetti(460, 105);
            burstDust(220, 95);
            spawnCandies(44);
            multiPulse(6);
        }

        function showOverlayDelayed() {
            if (overlayTimer) clearTimeout(overlayTimer);
            overlayTimer = setTimeout(() => {
                if (overlay) overlay.classList.add("show");
            }, 2400);
        }

        function hitPinata() {
            if (broken) return;

            hits += 1;
            updateHitsUI();

            batSwing();
            starNudge();
            hitEffects();

            const remaining = Math.max(0, MAX_HITS - hits);
            showCount(Math.max(1, remaining)); // 5..1
            spawnVoice(remaining <= 1 ? "¬°WOOOOO!" : "¬°DALE!");

            if (hits >= MAX_HITS) {
                broken = true;
                setState('<span class="ok">REVENT√ì</span> üéâ');
                breakEffects();
                switchToMananitas();
                showOverlayDelayed();
            } else {
                setState("Jugando");
            }
        }

        function resetAll() {
            hits = 0;
            broken = false;

            if (overlayTimer) clearTimeout(overlayTimer);
            overlayTimer = 0;

            if (overlay) overlay.classList.remove("show");
            if (candies) candies.innerHTML = "";
            if (lights) { lights.classList.remove("on"); lights.classList.remove("pulse"); }
            showCrack(false);

            stopFX();

            stopSafe(mananitasAudio);
            playSafe(chantAudio).then(ok => setAudioPill(audChant, ok, "üéµ Audio dale"));
            setAudioPill(audMan, true, "üé∂ Ma√±anitas"); // estado de carga, no de reproducci√≥n

            if (voices) voices.innerHTML = "";
            startVoices();

            setState("Jugando");
            updateHitsUI();
            showCount(MAX_HITS);
            spawnVoice("¬°DALE!");
        }

        function toggleMusic() {
            if (mananitasAudio.paused) {
                playSafe(mananitasAudio);
                if (btnAudioToggle) btnAudioToggle.textContent = "Pausar m√∫sica üîá";
            } else {
                pauseSafe(mananitasAudio);
                if (btnAudioToggle) btnAudioToggle.textContent = "Reproducir m√∫sica üîä";
            }
        }

        // =========================
        // FACEBOOK COMMENTS SDK (solo en HTTPS)
        // =========================
        function initFacebookComments() {
            const isHttps = typeof location?.protocol === "string" && location.protocol.startsWith("http");
            const fbComments = document.querySelector(".fb-comments");
            if (!fbComments) return;

            fbComments.setAttribute("data-href", isHttps ? location.href : "https://idappsh.site/"); // pon aqu√≠ tu URL final

            if (!isHttps) return; // en file:// no funciona

            // OJO: necesitas tu appId real si quieres el SDK completo.
            // Si no tienes appId, puedes omitir SDK y s√≥lo dejar el bloque.
            const appId = ""; // <-- si tienes App ID de FB, ponlo aqu√≠
            if (!appId) return;

            const js = document.createElement("script");
            js.async = true;
            js.defer = true;
            js.crossOrigin = "anonymous";
            js.src = `https://connect.facebook.net/es_LA/sdk.js#xfbml=1&version=v20.0&appId=${encodeURIComponent(appId)}`;
            document.body.appendChild(js);
        }

        // =========================
        // EVENTOS
        // =========================
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        if (pinataWrap) pinataWrap.addEventListener("click", hitPinata);

        if (btnHelpHit) btnHelpHit.addEventListener("click", hitPinata);
        if (btnReset) btnReset.addEventListener("click", resetAll);
        if (btnReplay) btnReplay.addEventListener("click", resetAll);
        if (btnAudioToggle) btnAudioToggle.addEventListener("click", toggleMusic);

        // Estado inicial (bloqueado)
        updateHitsUI();
        setState("Esperando");
        setAudioPill(audChant, false, "üéµ Audio dale");
        setAudioPill(audMan, false, "üé∂ Ma√±anitas");
        showCount(MAX_HITS);

        // Candado: al entrar desbloquea TODO + arranca audio
        if (btnEnter) {
            btnEnter.addEventListener("click", async () => {
                if (gate) gate.classList.add("hide");

                // habilitar controles
                if (btnHelpHit) btnHelpHit.disabled = false;
                if (btnReset) btnReset.disabled = false;

                setState("Jugando");
                startVoices();
                spawnVoice("¬°DALE!");

                const ok = await playSafe(chantAudio);
                setAudioPill(audChant, ok, "üéµ Audio dale");

                // dejamos ma√±anitas en ‚Äúcargado/pendiente‚Äù
                setAudioPill(audMan, true, "üé∂ Ma√±anitas");

                initFacebookComments();
            });
        }
    </script>
</body>

</html>